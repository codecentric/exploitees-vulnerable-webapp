import hashlib
import logging
import sqlite3

from flask import (
    Blueprint, flash, redirect, render_template, request, session, url_for
)

import exploitees.db as db

bp = Blueprint('auth', __name__, url_prefix='/auth')


def valid_login(username, password):
    conn = db.get_db_connection()
    hashed_pw = hashlib.md5(password.encode('UTF-8')).hexdigest()
    query = f"SELECT * from users WHERE username = '{username}' AND password_hash = '{hashed_pw}'"
    print(query)
    user = conn.execute(query).fetchone()
    return user is not None


@bp.route('/login', methods=['POST'])
def login():
    if valid_login(request.form['username'], request.form['password']):
        session['username'] = request.form['username']
        return redirect(url_for('exploitees.employees'))
    else:
        flash('Sorry, but you could not be logged in.', 'error')
        return render_template('index.html')


@bp.route('/logout')
def logout():
    del session['username']
    flash('You are now logged out again')
    return render_template('index.html')