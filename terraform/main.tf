terraform {
  required_providers {
    name = {
      source  = "hashicorp/aws"
      version = "4.14.0"
    }
  }
}

provider "aws" {
  region = local.region
}

variable "route53_zone_name" {
  type        = string
  description = <<-EOT
                The name of the route53 hosted zone in which a webgoat subdomain is created, e.g. yourname.codecentric.io
                If set, TLS cert and DNS entry is created. Access via port 443 on the output domain.
                If empty, no TLS and no DNS entries are created. Access via port 80 on the output domain.
                EOT
}

variable "vpc_cidr_block" {
  type    = string
  default = "10.201.0.0/16"
}

variable "webgoat_version" {
  type    = string
  default = "8.2.2"
}

locals {
  region               = "eu-central-1"
  codecentric_vpn_cidr = "87.191.39.154/32"
  subdomain_name       = "webgoat"
  domain_name          = "${local.subdomain_name}.${var.route53_zone_name}"
}

module "dns-tls" {
  source = "./tls"
  count = var.route53_zone_name != "" ? 1 : 0

  route53_zone_name = var.route53_zone_name
  domain_name = local.domain_name
  lb_dns_name = module.alb.lb_dns_name
  lb_zone_id = module.alb.lb_zone_id
}

output "url" {
  value = var.route53_zone_name != "" ? "https://${local.domain_name}" : "http://${module.alb.lb_dns_name}"
}
