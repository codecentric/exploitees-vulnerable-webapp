module "exploitees-vpc" {
  count  = (var.exploitees_user_count > 0) ? 1 : 0
  source = "terraform-aws-modules/vpc/aws"

  name = "cloud9-exploitees"
  cidr = var.exploitees_vpc_cidr_block

  azs            = [for suffix in ["a", "b"] : "${local.region}${suffix}"]
  public_subnets = cidrsubnets(var.exploitees_vpc_cidr_block, 8, 8)

  enable_nat_gateway      = false
  enable_vpn_gateway      = false
  map_public_ip_on_launch = true

  vpc_tags = {
    Name = "webgoat"
  }
}

resource "aws_cloud9_environment_ec2" "exploitees" {
  for_each      = toset([for u in aws_iam_user.workshop_users : u.arn])
  instance_type = "t3.small"
  name          = "exploitees-env"
  image_id      = "amazonlinux-2023-x86_64"
  owner_arn     = each.key
}

output "cloud9_url" {
  value = {
    for id in aws_cloud9_environment_ec2.exploitees : id.owner_arn =>
    "https://${local.region}.console.aws.amazon.com/cloud9/ide/${id.id}"
  }
}